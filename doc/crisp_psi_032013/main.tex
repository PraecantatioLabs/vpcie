\documentclass{beamer}
\usepackage[latin1]{inputenc}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{verbatim}
\usepackage{listings}
\usepackage{color}
\usetheme{Frankfurt}

\def\Tiny{\fontsize{4pt}{4pt}\selectfont}

\begin{document}

\usebackgroundtemplate
{
\includegraphics[height=\paperheight,width=\paperwidth]{pic/esrf_crisp/esrf_crisp_default.jpeg}
}

\begin{frame}{CRISP 2nd annual meeting}
\begin{center}
The use of hardware virtualization in RASHPA
\end{center}
\end{frame}

\begin{frame}{Contents}
  \begin{itemize}
  \item RASHPA context reminder
  \item Device virtualization
  \item The VPCIE framework
  \end{itemize}
\end{frame}

\begin{frame}{Context - RASHPA reminder}
  \begin{center}
    \includegraphics[width=20mm]{pic/dv_reminder/main.jpeg}
  \end{center}
  \begin{tiny}
  RASHPA basic goal is to transfer \textbf{detector} memory contents into
  a \textbf{backend} for further processing, visualisation or storage. To
  do so, RASHPA relies on low level hardware and software components\\
  \begin{itemize}
  \item a data transport layer, currently PCI Express over cable
  \item a data transmission engine implemented on XILINX FPGA
  \item LINUX kernel device driver and userland software
  \end{itemize}
  \end{tiny}
\end{frame}

\begin{frame}{Context - RASHPA project issues}
  \begin{small}
  Still being prototyped
  \begin{itemize}
  \item how to simplify hardware software codesign ?
  \end{itemize}

  Aims at using multiple PCIE links. Yet, the first prototype is single link
  \begin{itemize}
  \item how to scale the prototype platform ?
  \end{itemize}

  Well positionned to interface with PCIE based accelerating technologies
  \begin{itemize}
  \item how to test unavailable (too recent or expensive) hardware ?
  \end{itemize}
  \end{small}
\end{frame}

\begin{frame}{Context - solution}
  \begin{center} Solution: \textbf{device virtualization} \end{center}
\end{frame}

\begin{frame}{Device virtualization - main idea}
  \begin{center}
    \includegraphics[width=45mm]{pic/dv_redirect/main.jpeg}
  \end{center}
  \begin{small}
    Applications on a \textbf{host} machine access hardware via interfaces. By
    \textbf{instrumenting} these interfaces, one can \textbf{redirect} the accesses
    to a software implementing the device. The device is said to be
    \textbf{virtualized}.
  \end{small}
\end{frame}

\begin{frame}{Device virtualization - hardware access redirection (0)}
  \begin{small}
  Virtualization assumes device accesses are made using a known interface
  \begin{itemize}
  \item software library API (system calls)
  \item memory mapped registers
  \item CPU specific instructions (in, out)
  \end{itemize}
  \end{small}
\end{frame}

\begin{frame}{Device virtualization - hardware access redirection (1)}
  \begin{small}
  The interface is then instrumented to redirect access to the virtual device
  \begin{itemize}
  \item software hooking (code instrumentation, library replacing)
  \item instruction emulation (QEMU)
  \item hardware traps (page protection)
  \item architecture support (INTEL VT)
  \item paravirtualization (XEN)
  \end{itemize}
  \end{small}
\end{frame}

\begin{frame}{Device virtualization - applications}
  Device virtualization example applications
  \begin{itemize}
  \item support: application running on unmaintained platform
  \item security: sandboxing, reverse engineering
  \item quality: debugging, fault injection
  \item testing: milkymist, zinq, android
  \end{itemize}
\end{frame}

\begin{frame}{VPCIE - goals}
  VPCIE, a Virtual PCIE framework made for RASHPA
  \begin{itemize}
  \item virtualize PCIE endpoints
  \item the backend software must run \textbf{without any modification}
  \item generic enough to fit other projects
  \item virtualized device implementation usable in the real device
  \item thus, possible to use VHDL in the virtualized device
  \end{itemize}
\end{frame}

\begin{frame}{VPCIE - opensource building blocks}
  \begin{tiny}
  QEMU 
  \begin{itemize}
  \item http://wiki.qemu.org/Main\_Page
  \item architecture emulator (X86\_64, ARM ...)
  \item used to trap PCIE hardware accesses
  \end{itemize}
  GHDL
  \begin{itemize}
  \item http://ghdl.free.fr
  \item VHDL frontend for GCC
  \item used to implement device in VHDL
  \end{itemize}
  GTKWAVE
  \begin{itemize}
  \item http://gtkwave.sourceforge.net
  \item used to view simulated design signals in time
  \end{itemize}
  \end{tiny}
\end{frame}

\begin{frame}{VPCIE - implementation}
  \begin{center}
  \includegraphics[width=80mm]{pic/dv_implem/main.jpeg}
  \end{center}
\end{frame}

\begin{frame}{VPCIE - RASHPA possible setup}
  \begin{center}
  \includegraphics[width=80mm]{pic/dv_vpcie/main.jpeg}
  \end{center}
\end{frame}

\begin{frame}{VPCIE - other possible setups}
  \begin{center}
  \includegraphics[width=80mm]{pic/dv_ebone/main.jpeg}
  \end{center}
\end{frame}

\begin{frame}{VPCIE - RASHPA backend}
  RASHPA backend is a full featured LINUX system
  \begin{itemize}
  \item runs in a QEMU virtual machine
  \item PCIE accesses are trapped and sent over TCP to the devices
  \item PCIE forwarder is available as a QEMU patch
  \end{itemize}
\end{frame}

\begin{frame}{VPCIE - RASHPA devices}
  RASHPA devices
  \begin{itemize}
  \item run as a LINUX processes, can be duplicated at will
  \item can be implemented in C or VHDL
  \item PCIE made simple, focus on device logic
  \end{itemize}
\end{frame}

\begin{frame}[containsverbatim]
 \frametitle{VPCIE - VHDL interface}
 \begin{tiny}
 \lstset{commentstyle=\color{blue}}
 \lstset{language=VHDL}
 \begin{lstlisting}[frame=tb]
entity endpoint is
 port
 (
  rst: in std_ulogic;
  clk: in std_ulogic;

  req_en: out std_ulogic;
  req_wr: out std_ulogic;
  req_bar: out std_ulogic_vector(pcie.BAR_WIDTH - 1 downto 0);
  req_addr: out std_ulogic_vector(pcie.ADDR_WIDTH - 1 downto 0);
  req_data: out std_ulogic_vector(pcie.DATA_WIDTH - 1 downto 0);

  rep_en: in std_ulogic;
  rep_data: in std_ulogic_vector(pcie.DATA_WIDTH - 1 downto 0);

  mwr_en: in std_ulogic;
  mwr_addr: in std_ulogic_vector(pcie.ADDR_WIDTH - 1 downto 0);
  mwr_data: in std_ulogic_vector(pcie.PAYLOAD_WIDTH - 1 downto 0);
  mwr_size: in std_ulogic_vector(pcie.SIZE_WIDTH - 1 downto 0);

  msi_en: in std_ulogic
 );
end entity;
 \end{lstlisting}
 \end{tiny}
\end{frame}

\begin{frame}[containsverbatim]
 \frametitle{VPCIE - C interface}
 \begin{tiny}
 \lstset{commentstyle=\color{blue}}
 \lstset{language=C}
 \begin{lstlisting}[frame=tb]

/* runtime initialization */
int pcie_init_net(pcie_dev_t*, ...);
int pcie_fini(pcie_dev_t*);
int pcie_loop(pcie_dev_t*);

/* misc config byte accessors */
int pcie_set_deviceid(pcie_dev_t*, ...);
int pcie_set_vendorid(pcie_dev_t*, ...);

/* PCIE BAR access handlers */
typedef void (*pcie_readfn_t)(uint64_t, void*, size_t, void*);
typedef void (*pcie_writefn_t)(uint64_t, const void*, size_t, void*);
int pcie_set_bar(pcie_dev_t*, ..., pcie_readfn_t, pcie_writefn_t, ...);

/* host memory read write operations */
int pcie_write_host_mem(pcie_dev_t*, uint64_t, size_t*);
int pcie_read_host_mem(pcie_dev_t*, uint64_t, size_t*);

/* send an MSI */
int pcie_send_msi(pcie_dev_t*);
 \end{lstlisting}
 \end{tiny}
\end{frame}

\begin{frame}{VPCIE - benefits}
  Hardware software codesign
  \begin{itemize}
  \item reduce development time
  \item no \textbf{modification} on the backend software (esp. driver)
  \item act as a stimuli generator for VHDL simulations
  \end{itemize}

  Platform scaling
  \begin{itemize}
  \item one PCIE endpoint per LINUX process
  \end{itemize}

  Investigate unavailable technologies
  \begin{itemize}
  \item NVM Express support for QEMU is available
  \end{itemize}
\end{frame}

\begin{frame}{VPCIE - more benefits}
  Virtual machine
  \begin{itemize}
  \item resources easily changed (RAM amount ...)
  \item test with different CPU architectures (x86, x86\_64, ARM ...)
  \item small LINUX disk images reduce reboot times (few seconds)
  \end{itemize}
  Fault injection
  \begin{itemize}
  \item LINUX and software response to PCIE device disconnection
  \end{itemize}
\end{frame}

\begin{frame}{VPCIE - availability}
  \begin{center}https://github.com/texane/vpcie\end{center}
\end{frame}

\begin{frame}{VPCIE - demo}
  \begin{center}demo\end{center}
\end{frame}

\end{document}
